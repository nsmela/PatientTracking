@inject PatientService patientService
@inject NavigationManager navigationManager

@if(patient is null){
    <MudProgressCircular />
} else {
    <MudContainer Class="ma-4 pa-2" >
        <MudGrid xs="12" md="8" lg="4">
            <MudItem xs="12" md="8" Elevation="1">
                <MudCard Class="pa-n4 mt-0 mud-theme-primary py-4 px-4 rounded-t-lg">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@patient.StartDate</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIconButton Icon="@Icons.Material.Filled.EditNote" Color="Color.Default" OnClick="(() => EditPatient())" />
                            <MudIconButton Icon="@Icons.Material.Filled.PersonRemove" Color="Color.Default" OnClick="(()=> DeletePatient())"/>
                        </CardHeaderActions>
                    </MudCardHeader>
                </MudCard>
                <MudPaper Elevation="2" Class="pa-4 mt-n8">
                    <MudText>@patient.LastName, @patient.FirstName</MudText>
                    <MudText>@patient.Id</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" md="8">
                <MudGrid>
                    @foreach (var group in patient.TaskGroups) {
                        <MudItem xs="12" md="8">
                            <MudPaper Elevation="2" Class="pa-4">
                                <MudText Typo="Typo.h6">@group.Label</MudText>
                                    @foreach(var task in group.Tasks){
                                        <PatientTask TaskItem="@task" Edit="EditMode.DataEntry" />
                                    }
                                </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            </MudItem>
        </MudGrid>
    </MudContainer>
}

@code {
    [Inject] private IDialogService dialogService { get; set; }

    [Parameter] public string PatientId { get; set; }

    Patient? patient = null;

    protected override async Task OnParametersSetAsync() {
        patient = await patientService.GetPatientByIdAsync(PatientId);
    }

    private async Task UpdatePatientTask(string groupLabel, string label, object value) {
        int groupIndex = patient.TaskGroups.FindIndex(g => g.Label == groupLabel);
        int index = patient.TaskGroups[groupIndex].Tasks.FindIndex(t => t.Label == label);
        if (index >= 0) {
            patient.TaskGroups[groupIndex].Tasks[index].SetValue(value);
            patientService.UpdatePatient(patient);
        }
    }

    private async Task DeletePatient() {
        var result = await dialogService.ShowMessageBox(
            "Warning",
            "Deleting can not be undone!",
            yesText: "Delete!", 
            cancelText: "Cancel");

        if (result is null) return;

        patientService.RemovePatient(PatientId);
        navigationManager.NavigateTo("/patients");
    }

    private async Task EditPatient(){
        navigationManager.NavigateTo($"/editpatient/{PatientId}");
    }
}
